<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NTT DATA Payment Test</title>
    <script src="https://pgtest.atomtech.in/staticdata/ots/js/atomcheckout.js"></script>
</head>

<body>
<h2>Test Payment</h2>
<button onclick="startPayment()">Pay Now</button>

<script>
    async function startPayment() {
        try {
            const backendUrl = "http://localhost:8080/api/v1/PaymentProcess";

            // Generate unique UUID
            let dt = new Date().getTime();
            let uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                let r = (dt + Math.random() * 16) % 16 | 0;
                dt = Math.floor(dt / 16);
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });

            // Correct JSON matching Java field names
            const payload = {
                payInstrument: {
                    extras: {
                        udf1: "-",
                        udf2: "-",
                        udf3: "-",
                        udf4: "-",
                        udf5: uuid
                    },
                    payDetails: {
                        amount: 1.12,
                        product: "NSE"
                    },
                    custDetails: {
                        custEmail: "testuser@nttdata.com",
                        custMobile: "9797979797"
                    },
                    headDetails: {
                        api: "AUTH",
                        version: "OTSv1.1",
                        platform: "FLASH"
                    },
                    merchDetails: {
                        userId: "998776",
                        merchId: "665887",
                        password: "Test@123456",
                        merchTxnId: uuid,
                        merchTxnDate: "2025-02-26 18:45:00"
                    },
                    payModeSpecificData: {
                        subChannel: "DC"
                    }
                }
            };

            console.log("Final Payload Sent →", payload);

            // Send to backend
            const response = await fetch(backendUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            console.log("Backend Response →", data);

            if (data.responseDetails?.txnStatusCode !== "OTS0000") {
                alert("Payment initiation failed: " + data.responseDetails?.txnDescription);
                return;
            }

            // Atom token launch
            const options = {
                atomTokenId: data.atomTokenId,
                merchId: "446442",
                custEmail: "testuser@nttdata.com",
                custMobile: "9797979797",
                returnUrl: "http://localhost:8080/api/v1/initiatepaymentcallback"
            };

            console.log("Launching AtomPaynetz →", options);

            new AtomPaynetz(options, 'uat');

        } catch (error) {
            console.error("Error:", error);
            alert("Request failed — see console.");
        }
    }
</script>

</body>
</html>
